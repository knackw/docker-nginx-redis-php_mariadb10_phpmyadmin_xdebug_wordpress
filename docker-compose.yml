version: "3.1"
services:
    wordpress:
      container_name: ${CONTAINER_PREFIX}-wordpress
      build:  .
      depends_on:
        - "db"
      environment:
        WORDPRESS_DB_USER: ${WORDPRESS_DB_USER}
        WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
        WORDPRESS_DB_HOST: db
        WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
        WORDPRESS_DOMAIN: ${WORDPRESS_DOMAIN}
        WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER}
        WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD}
        WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL}
      volumes:
        - type: bind
          source: ./data/wp-volume
          target: /www
          consistency: cached
        - type: bind
          source: ./etc/certs
          target: /certs
          consistency: cached
      ports:
        - 80:80
        - 443:443
      networks:
        - network

    db:
      container_name: ${CONTAINER_PREFIX}-db
      image: mariadb:10.6.0
      command: --default-authentication-plugin=mysql_native_password
      restart: always
      environment:
        MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
        MYSQL_DATABASE: ${MYSQL_DATABASE}
        MYSQL_USER: ${MYSQL_USER}
        MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      ports: [ '6033:3306' ]
      expose: [ '3306' ]
      volumes:
        - type: bind
          source: ./data/db-volume
          target: /var/lib/mysql
          consistency: delegated
      networks:
        - network

    redis:
      container_name: ${CONTAINER_PREFIX}-redis
      image: "redis:alpine"
      command: redis-server --requirepass redispass
      ports:
        - "6379:6379"
      volumes:
        - type: bind
          source: ./etc/redis.conf
          target: /usr/local/etc/redis/redis.conf
          consistency: cached
      environment:
        REDIS_REPLICATION_MODE: ${REDIS_REPLICATION_MODE}
      networks:
        - network

    phpmyadmin:
      container_name: ${CONTAINER_PREFIX}-phpmyadmin
      image: phpmyadmin/phpmyadmin:4.7
      restart: always
      ports: [ '8081:80' ]
      links: [ 'db:db' ]
      environment:
        PMA_HOST: db
        PMA_USER: ${WORDPRESS_DB_USER}
        PMA_PASSWORD: ${WORDPRESS_DB_PASSWORD}
        PMA_ARBITRARY: ${PMA_ARBITRARY}
      networks:
        - network

    mail:
      container_name: ${CONTAINER_PREFIX}-mail
      image: mailhog/mailhog
      ports:
        - "8025:8025"
        - "1025:1025"
      networks:
        - network

volumes:
  data:

networks:
  network:
    driver: bridge